<div class="transaction-list-wrapper">
@if ( showFilters ){ <transaction-filters [(filter)]="filters" (filterChange)="refresh()"></transaction-filters> }
@if ( txns.length > 0){
    <table class="data item-list" [ngClass]="editable ? 'editable': ''">
    @if ( withHeader ) {
        <thead>
            <tr>
        @if ( txShow?.id )              {<th>Transaction ID</th>}
        @if ( txShow?.datePending )     {<th (click)="sortBy('datePending');">Date Pending</th>}
       <!-- Always show post date -->    <th (click)="sortBy('datePosted');">Date Posted</th>
        @if ( txShow?.account )         {<th (click)="sortBy('accountId');">Account</th>}
        <!-- Always show amount -->      <th (click)="sortBy('amount');">Amount</th>
        <!-- Always show desc. -->       <th (click)="sortBy('description');">Description</th>
        @if ( txShow?.merchant )        {<th (click)="sortBy('merchant');">Merchant</th>}
        @if ( txShow?.transactionType ) {<th>Transaction Type</th>}
        @if ( withTags )                {<th>Budgets</th>}
            </tr>
        </thead>
    }
        <tbody>
    @for(txn of txns; track txn.id) {
        <tr>
            @if (txShow?.id) {<td> <span class="md-truncate"> {{ txn.id }} </span> </td>}
            @if (txShow?.datePending) {<td txn-edit="true" [ngSwitch]="!!currentlyEditing.datePending">
                <span *ngSwitchCase="false"> {{ txn.datePending | date:'yyyy-MM-dd' }} </span>
                <div *ngSwitchCase="true" ng-blur="$emit('yaba.edit2view-txn-datePending', $event)">
                    <input
                    type="date"
                    [(ngModel)]="txn.datePending"
                    (blur)="edit2view('datePending', txn.datePending)"
                    class="txn-edit-field"
                    ng-blur="$emit('yaba.edit2view-txn-datePending', $event)"
                    />
                </div>
            </td>}
            <td txn-edit="true" [ngSwitch]="!!currentlyEditing.datePosted">
                <span *ngSwitchCase="false"> {{ txn.datePosted | date:'yyyy-MM-dd' }} </span>
                <div *ngSwitchCase="true" ng-blur="$emit('yaba.edit2view-txn-datePosted', $event)">
                    <input
                      type="date"
                      [(ngModel)]="txn.datePosted"
                      class="txn-edit-field"
                      ng-blur="$emit('yaba.edit2view-txn-datePosted', $event)"
                    />
                </div>
            </td>

            @if ( txShow?.account ) {<td> <span> {{ accountId2name[txn.accountId] || '{!unknown account id!}' }} </span> </td>}

            <td txn-edit="true" [(ngModel)]="txn.amount" [ngSwitch]="!!currentlyEditing.amount">
                <span *ngSwitchCase="false" [textContent]="txn.amount | currency" [ngClass]="{'negative': txn.amount < 0}"></span>
                <span *ngSwitchCase="true">
                    <input
                    type="number"
                    [(ngModel)]="txn.amount"
                    class="txn-edit-field"
                    ng-blur="$emit('yaba.edit2view-txn-amount', $event)"
                    />
                </span>
            </td>
            <td txn-edit="true" [(ngModel)]="txn.description" [ngSwitch]="!!currentlyEditing.description">
                <!-- md-truncate has failed me here! :sob: -->
                <span *ngSwitchCase="false"> {{ limit == -1 ? txn.description: txn.description.slice(0, 30) + (txn.description.length > 30? '...': '') }} </span>
                <span *ngSwitchCase="true">
                    <input
                    type="text"
                    [(ngModel)]="txn.description"
                    class="txn-edit-field"
                    ng-blur="$emit('yaba.edit2view-txn-description', $event)"
                    />
                </span>
            </td>
            @if ( txShow?.merchant ) {<td txn-edit="true" [(ngModel)]="txn.merchant" [ngSwitch]="!!currentlyEditing.merchant">
                <span *ngSwitchCase="false"> {{ txn.merchant }} </span>
                <span *ngSwitchCase="true">
                    <input
                    type="text"
                    [(ngModel)]="txn.merchant"
                    class="txn-edit-field"
                    ng-blur="$emit('yaba.edit2view-txn-merchant', $event)"
                    />
                </span>
            </td>}
            @if ( txShow?.transactionType ) {<td txn-edit="true" [(ngModel)]="txn.transactionType" [ngSwitch]="!!currentlyEditing.transactionType">
                <span *ngSwitchCase="false"> {{ txn.transactionType }} </span>
                <span *ngSwitchCase="true">
                    <input
                    type="text"
                    [(ngModel)]="txn.transactionType"
                    class="txn-edit-field"
                    ng-blur="$emit('yaba.edit2view-txn-transactionType', $event)"
                    />
                </span>
            </td>}
            @if ( withTags )
            {<td txn-edit="true" [(ngModel)]="txn.tags" [ngSwitch]="!!currentlyEditing.tags">
                <span *ngSwitchCase="false"> {{ txn.tags.join(", ") }} </span>
                <span *ngSwitchCase="true">
                    <mat-chip-grid #chipGrid aria-label="Enter hidden tags" *ngFor="let tag of txn.tags; track tag">
                          <mat-chip-row
                            (removed)="removeTag(txn, $event)"
                            [editable]="true"
                            (changed)="save()"
                            [aria-description]="'press enter to edit tag'">
                            <span [textContent]="tag"></span>
                            <button matChipRemove [attr.aria-label]="'remove tag'">
                              <mat-icon>cancel</mat-icon>
                            </button>
                          </mat-chip-row>
                        <input placeholder="New tag..."
                               [matChipInputFor]="chipGrid"
                               [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
                               [matChipInputAddOnBlur]="addOnBlur"
                               (matChipInputTokenEnd)="addTag(txn, $event)"/>
                      </mat-chip-grid>

                      <!-- <mat-chips
                        [(ngModel)]="txn.tags"
                        ng-blur="$scope.$emit('yaba.edit2view-txn-tags', $event)"
                        md-readonly="false"
                        md-removable="true"
                        md-enable-chip-edit="true"
                    ></mat-chips> -->
                </span>
            </td>}
        </tr>
    }
        </tbody>
    </table>
}
    @if ( showPaginate && txns.length > 10 ){ <yaba-pagination [itemCount]="txns.length"></yaba-pagination> }
    <debug>
        txn.length: <span [textContent]="txns.length"></span>
        limit: <span [textContent]="limit"></span>
    </debug>
</div>
